<!--
  Catena-X - Product Passport Consumer Backend
 
  Copyright (c) 2022, 2023 BASF SE, BMW AG, Henkel AG & Co. KGaA

  See the NOTICE file(s) distributed with this work for additional
  information regarding copyright ownership.
 
  This program and the accompanying materials are made available under the
  terms of the Apache License, Version 2.0 which is available at
  https://www.apache.org/licenses/LICENSE-2.0.
 
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
  either express or implied. See the
  License for the specific language govern in permissions and limitations
  under the License.
 
  SPDX-License-Identifier: Apache-2.0
-->

<h1 style="display:flex; align-items: center;"><img src="../../docs/catena-x-logo.svg"/>&nbsp;&nbsp;Digital Product Pass Backend</h1>


<h2><strong>Version</strong>: <span style="color: cyan">v2.0.1</span><h2>

<br>

# Table of contents
<!-- TOC -->
- [Table of contents](#table-of-contents)
- [What is this backend app responsible for?](#what-is-this-backend-app-responsible-for)
- [Services Available](#services-available)
  - [Authentication Services](#authentication-services)
  - [API Services](#api-services)
    - [Data](#data)
    - [Passport API](#passport-api)
          - [Request body](#request-body)
      - [Versions Available](#versions-available)
    - [Contract API](#contract-api)
          - [Request body](#request-body-1)
          - [Request body](#request-body-2)
          - [Request body](#request-body-3)
          - [Request body](#request-body-4)
          - [Request body](#request-body-5)
  - [Public APIs](#public-apis)
          - [Response](#response)
  - [OSS License Check](#oss-license-check)
  - [Swagger Docs](#swagger-docs)
- [Run the application](#run-the-application)
  - [Modify the configurations in the deployment files](#modify-the-configurations-in-the-deployment-files)
- [TL;DR](#tldr)
  - [Install](#install)
- [License](#license)
<!-- TOC -->

# What is this backend app responsible for?

This backend includes the services and *logics* to manage the *passports* of the `frontend app`.

# Services Available

## Authentication Services
All Authenticated APIs required a `AccessToken` JWT Token generated by the login in the frontend or in the Catena-X Keycloak instance.

```yaml
{
    headers: {
        Authorization: "Bearer <<AccessToken>>"
    }
}
```

For login and log out!
```bash
------
/auth/check #With this api you can check you authentication status.
------
/auth/token #Request token from the keycloak instance
------
/auth/userInfo #With this api you can get your user information.
------
```

## API Services
>  **_NOTE:_** You must be authenticated with the keycloak instance to access this APIs


### Data
Get data from a Catena-X Provider by using its processId, contractId and a token, this retrieves product passport after a successful negotiation.

```bash
/api/data #Returns the data negotiated and transferred
```
###### Request body
```json
{
    "processId": "string",
    "contractId": "string",
    "token": "string"
}
```

### Contract API

```bash
/api/contract/create #Creates a process and checks for the viability of the data retrieval
```
###### Request body
```json
{
    "id": "string",
    "type": "string"
}
```

```bash
/api/contract/search #Searches for a passport with the following id
```
###### Request body
```json
{
    "processId": "string",
    "id": "string",
    "version": "string",
    "idType": "string",
    "dtIndex": 0,
    "idShort": "string"
}
```

```bash
/api/contract/sign #Sign contract retrieved from provider and start negotiation
```
###### Request body
```json
{
    "processId": "string",
    "contractId": "string",
    "token": "string"
}
```

```bash
/api/contract/decline #Decline passport negotiation
```
###### Request body
```json
{
    "processId": "string",
    "contractId": "string",
    "token": "string"
}
```

```bash
/api/contract/cancel #Cancel the negotiation
```
###### Request body
```json
{
    "processId": "string",
    "contractId": "string",
    "token": "string"
}
```

```bash
/api/contract/status/<processId> #Get status from process
```

## IRS API

```bash
/api/irs/<processId>/<searchId> #Endpoint called by the IRS to set status completed
```
###### Request parameters
```
- Id
- State
```
```bash
/api/irs/<processId>/tree #Api called by the frontend to obtain the tree of components
```
```bash
/api/irs/<processId>/state #Api called by the frontend to check if the process is finished
```
```bash
/api/irs/<processId>/components #Api called by the frontend to obtain the list of components of the tree
```

## Public API

Public APIs don't require authentication
```bash
/health #Get the health status of the server
```
###### Response
```json
{
    "message": "RUNNING",
    "status": 200,
    "data": "24/11/2022 17:48:18.487"
}
```

```bash
/endpoint/<processId> #Receives the EDR from the EDC Consumer and get the passport json 
```

```bash
/endpoint/<processId>/<endpointId> #Receives the EDR for the EDC Consumer and queries for the dDTR
```



## OSS License Check

The third party library dependecies, utilized in this app have to  be approved from The Eclipse Foundation.

The [Dash Licence Tool](https://github.com/eclipse/dash-licenses) is used to scan the dependencies

[OSS License Checks with Dash & Compliance with Apache 2.0](https://confluence.catena-x.net/pages/viewpage.action?pageId=54989501)

At the time of writing this manual, the dependencies have status approved and therefore no need to generate  IP Team Review request further.

[Maven plugin](https://github.com/eclipse/dash-licenses/blob/master/README.md#maven-plugin-options) used to check OSS license

How to run:
```bash
mvn org.eclipse.dash:license-tool-plugin:license-check -Ddash.summary=DEPENDENCIES
```


## Swagger Docs

Swagger documentation is now automatically available at the following path:

```https://<host>/swagger-ui/index.html```

![img.png](docs/media/img2.png)

For authorization, you will need to add a JWT Access token from the Catena-X IAM:

![img3.png](docs/media/img3.png)

# Run the application

Use maven to run the spring boot application:
```bash
mvn spring-boot:run
```

If you want to run the application in a different way checkout the [frequently asked questions](#frequently-asked-questions) section below.

## Modify the configurations in the deployment files

You can use the default configuration to start the application:
```charts/digital-product-pass/values.yaml```

However if you need to change it just create a new environment with this naming convention: ```values-env`.yaml``` where ```env``` is the name of your environment. You can use as an example the following configuration file: ```charts/digital-product-pass/values-int.yaml```.

The configuration for the consumer backend application is a yaml file that is configured in the following tag: ```backend.application```. Before the application starts all the configuration parameters must be specified, since they are required for initialization and will be checked at the test fase.

Once you configured the application use the follow the [TL;DR](#tldr) below to ```build the image and start the application``` using helm charts.

# TL;DR 

## Install
[Backend Installation](../../INSTALL.md)

# License
[Apache-2.0](https://raw.githubusercontent.com/catenax-ng/product-battery-passport-consumer-app/main/LICENSE)

